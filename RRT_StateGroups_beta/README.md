# 配布元
[GitHub-rinronta-RPGMakerMV_Plugins-RRT_StateGroups_beta](https://github.com/rinronta/RPGMakerMV_Plugins/blob/master/RRT_StateGroups_beta/RRT_StateGroups_beta.js)

# ライセンス
MITライセンスで公開します。

# 仕様詳細
## ◆設定方法◆
1. 本プラグインをプラグイン管理に追加してください。
2. プラグイン設定画面で、グループの各項目を設定します(後述)。
3. 各ステートの設定画面で`<RSGstateGroupId:xx>`を入力します。xxはステートが属すグループIDです。
4. 必要に応じて、ステートの設定画面のメモ欄に規定のノートタグをつけます。

## ◆グループ設定◆
  
### 【name】
ステートの名称です。処理には全く関わらないのでメモ程度に利用してください。

***
### 【type】
同属ステートの「打消」の方式です。１キャラに複数の同属ステートを付加できない仕様になっています。  
既に同属ステートが付加されていたとき、後から付加されるステートが上書するか、無効になるか、中和されるか(どちらも無効になるか)を設定できます。  
後述のrankTypeを用いる場合は、同属同ランク(同格)のステートにのみ適用されます。  

#### [overwrite]
	「上書」です。後から付加される同属ステートの付加が有効になり、既に付加されていた同属ステートは解除されます。
#### [cancel]
	「無効」です。後から付加される同属ステートの付加は無効になり、既に付加されている同属ステートは継続します。
#### [neutralize]
	「中和」です。後から付加される同属ステートの付加は無効になり、既に付加されていた同属ステートも解除されます。

***
### 【rankType】
ランク値による優先方式です。  
この項目では、既に同属のステートが付加されていたとき、付加されようとしているステートのランク値の高低によって、上書と無効の関係を設定できます。
#### [none]
	ランク値による優先を用いません。ランク値による優先は発生せず、常に前項のtypeによって判定されます。
#### [higher]
	付加されている同属ステートよりも高ければ、「上書」になります。  
	付加されている同属ステートよりも低ければ、「無効」になります。  
	付加されている同属ステートと同値であれば、typeに従います。
#### [lower]
	付加されている同属ステートよりも低ければ、「上書」になります。  
	付加されている同属ステートよりも高ければ、「無効」になります。  
	付加されている同属ステートと同値であれば、typeに従います。

***
### 【flag】
通常切替フラグです。切替の条件です。ステートの設定画面のステート解除条件と対応しています。  
各項目が有効でも無効でも動作するものと、無効なら動作しないものがありますので注意してください。
基本的には解除条件は有効にすることをお勧めします。  
同じ種類のフラグは１つしか用いることができませんが、異なる種類のフラグ(xFlag,sFlag)と共存できます。     

#### [none]
	このフラグを用いません。
#### [battleEnd]
	戦闘終了時に切り替わります。有効でも無効でも動作します。
#### [restrict]
	行動制約時に切り替わります。有効でも無効でも動作します。
#### [turns]
	継続ターン数によって切り替わります。  
	自動解除のタイミングが「なし」の場合は動作しません。  
	「行動終了時」または「ターン終了時」のどちらかに設定してください。
#### [damage]
	ダメージを受けたことによって切り替わります。  
	有効でも無効でも動作します。作動確率は「ダメージによる解除確率」に従います。
#### [steps]
	歩数によって切り替わります。無効なら動作しません(ステートの歩数カウンタが動作しないため)。
	
***
### 【xFlag】
拡張切替フラグです。  
属する各ステートのノートタグ<RSGxRate:xx>が、切り替え発生確率の判定に用いられます。  
その記述がない、あるいは有効な値がない場合は、必ず切り替えが発生することになります。

#### [none]
	このフラグを用いません。
#### [remove]
	ステート解除時に切り替わります。  
	ただし、同グループの「上書」による解除や、別ステートへの「切替」による解除には反応しません。  
	相殺グループの付加による解除には反応します。
#### [battleStart]
	戦闘開始時に切り替わります。
#### [firstAction]
	そのターンの初回行動時、厳密にはその直前に切り替わります。
#### [allActionsEnd]
	そのターンの全ての行動が終わった後に切り替わります。
#### [turnEnd]
	そのターンの全キャラクターの行動が終わった後に切り替わります。

***
### 【sFlag】/【sValue】
特殊切替フラグです。  
sValueに有効な値が入力されていない場合は、sFlagは作動しません。  
属する各ステートのノートタグ<RSGsRate:xx>が、切替の発生確率の判定に用いられます。  
その記述がない、あるいは有効な値がない場合は、必ず切り替えが発生することになります。  
sFlagを用いるには、その種類によってそれぞれのsValueを設定する必要があります。  
この項目を[param]や[rateOfHMT]にした場合、targetの動作が他のものと異なることになります。

#### [none]
	このフラグを用いません。
#### [addedState]
	sValueにステートのIDを半角数字で記入してください。  
	そのステートが付加された直後に切り替えが発生します。  
	「切替による付加」には反応しませんが、「属性攻撃による付加」には反応します。
#### [addedStateGroup]
	sValueにステートグループIDを設定して下さい。  
	そのグループに属すステートが付加された直後に切り替えが発生します。
	「切替による付加」には反応しませんが、「属性攻撃による付加」には反応します。
	現状では、自分と同じグループの付加には反応しないようになっています。
#### [damagedElement]
	sValueに属性IDを半角数字で記入して下さい。  
	その属性でダメージを受けた直後に切り替えが発生します。
#### [usingSkill]
	sValueには、スキルIDを半角数字で記入して下さい。  
	そのスキルのコストを消費する直前に切り替えが発生します。
#### [usingSkillType]
	sValueには、スキルタイプIDを半角数字で記述して下さい。  
	スキルの成功に関わらず、そのタイプに属すスキルのコストを消費する直前に切り替えが発生します。
#### [param(能力値)]
	属するステートに「有効範囲」が発生するフラグです。  
	sValueには、能力値のID(＝アルファベットの略称)を記述して下さい。  
	能力値が有効範囲から外れた場合に「必ず作動する」ことになるため、ノートタグ`<RSGsRate:xx>`の記入は無視されます。  
	有効範囲の値(下限と上限)には、属するステートのランク値の数値が転用されます。  
##### target[rankUp]またはtarget[rankDown]の場合
* 規定した能力値が上限値に達すればtarget[rankUp]と同じ挙動になります。
* 規定した能力値が下限値に達すればtarget[rankDown]と同じ挙動になります。
##### target[random]または[none]の場合、
* 規定した能力値が上限値または下限値に達すれば解除されることになります。
##### target[state]の場合、
* 規定した能力値が上限値または下限値に達すれば、各ステートのノートタグ`<RSGtargetState:xx>`で規定したステートに切り替わります。
なお、このフラグを持つグループに属するステートを付加されようとしたとき、有効範囲に合ったステートが自動的に付加されることになります。  
上限値と下限値の詳しい解説は、[target]の項を参照して下さい。

#### [rateOfHMT(HP/MP/TPの残存割合)]
	属するステートに「有効範囲」が発生するフラグです。  
	sValueには hp mp tp のいずれかを記述して下さい。残存値の最大値に対する割合が作動の判定に用いられます。  
	それ以外は[param]と同様です。

***
### 【target】
切替先となるステートを設定します。  
flag、xFlag、sFlagで設定したそれぞれの条件が満たされたときに、この設定に従って切り替わります。  
target[state]の場合は、各ステートのノートタグ`<RSGtargetState:xx>`で設定したステートへ切り替わることになります。

「切替」の作動機序としては基本的に、  
1. 元のステートが解除(削除)される  
2. 切替先ステートが付加される  
という機序で動きます。  
ただしこの時の「解除」および「付加」は、
* xFlag[remove]
* sFlag[addedState]
* sFlag[addedStateGroup]
を動作させることはありません。

#### [none]
	何も起こりません。
	ただし、sFlag[param]および[rateOfHMT]の場合は、規定した能力値が上限あるいは下限に達することによって解除されます。  

##### rankType[higher]の場合
* 上限値「次に高ランクな同属ステートのランク値」と等値以上になれば解除されます。現在のステートが最高ランクの場合は何も起こりません。
* 下限値「現在のステートのランク値」を下回れば解除されます。現在のステートが最低ランクの場合は何も起こりません。
##### rankType[lower]の場合
* 上限値「現在のステートのランク値」を上回れば解除されます。現在のステートが最高ランクの場合は何も起こりません。
* 下限値「次に低ランクな同属ステートのランク値」と等値以下になれば解除されます。現在のステートが最低ランクの場合は何も起こりません。
##### rankTyoe[none]の場合
* 上限値「次に高ランクな同属ステートのランク値」と等値以上になれば解除されます。現在のステートが最高ランクの場合は何も起こりません。
* 下限値「次に低ランクな同属ステートのランク値」と等値以下になれば解除されます。現在のステートが最低ランクの場合は何も起こりません。

#### [rankUp]
	同じグループの中でランク値が次に高いステートに切り替わります。次に高いステートがない場合は何も起こりません。
	sFlag[param]および[rateOfHMT]の場合は、規定した能力値が上限あるいは下限に達することによって切り替えが生じます。  

##### rankType[higher]、およびrankType[none]の場合
* 上限値「次に高ランクな同属ステートのランク値」と等値以上になればそのステートに切り替わります。現在のステートが最高ランクの場合は切り替わりません。
* 下限値「現在のステートのランク値」を下回れば次にランク値の低いステートに切り替わります。現在のステートが最低ランクの場合は切り替わりません。
##### rankType[lower]の場合
* 上限値「現在のステートのランク値」を上回ればそのステートに切り替わります。現在のステートが最高ランクの場合は切り替わりません。
* 下限値「次に低ランクな同属ステートのランク値」と等値以下になればそのステートに切り替わります。現在のステートが最低ランクの場合は切り替わりません。

#### [rankDown]
	同じグループの中でランク値が次に大きいステートに切り替わります。
	次に低いステートがない場合は何も起こりません。  

##### rankType[higher]の場合  
* 上限値「次に高ランクな同属ステートのランク値」と等値以上になればそのステートに切り替わります。現在のステートが最高ランクの場合は切り替わりません。
* 下限値「現在のステートのランク値」を下回れば次にランク値の低いステートに切り替わります。現在のステートが最低ランクの場合は切り替わりません。
##### rankType[lower]および[none]の場合  
* 上限値「現在のステートのランク値」を上回ればそのステートに切り替わります。現在のステートが最高ランクの場合は切り替わりません。
* 下限値「次に低ランクな同属ステートのランク値」と等値以下になればそのステートに切り替わります。現在のステートが最低ランクの場合は切り替わりません。

#### [random]
同じグループのランダムなステートに切り替わります。  
ただしsFlag[param]および[rateOfHMT]の場合、この設定は無視され、target[none]と同様の挙動になるため注意して下さい。  
今後、この仕様は「有効範囲に合う複数のステートのうちランダムに切り替わる」に変更される可能性があります。

#### [state]
	ノートタグ`<RSGtargetState:xx>`で指定したステートに切り替わります。  
	ノートタグに有効な値が記入されていない場合は切替が起こりません。  
	切替先のステートのグループの設定にsFlag[param]および[rateOfHMT]があった場合、自動的に有効範囲に合ったステートに切り替わります。  
	sFlag[param]および[rateOfHMT]の場合は、規定した能力値が上限あるいは下限に達することによって切り替わります。  
##### rankType[higher]の場合
* 上限値「次に高ランクな同属ステートのランク値」と等値以上になれば解除されます。現在のステートが最高ランクの場合は何も起こりません。
* 下限値「現在のステートのランク値」を下回れば解除されます。現在のステートが最低ランクの場合は何も起こりません。
##### rankType[lower]の場合
* 上限値「現在のステートのランク値」を上回れば解除されます。現在のステートが最高ランクの場合は何も起こりません。
* 下限値「次に低ランクな同属ステートのランク値」と等値以下になれば解除されます。現在のステートが最低ランクの場合は何も起こりません。

##### rankTyoe[none]の場合
* 上限値「次に高ランクな同属ステートのランク値」と等値以上になれば解除されます。現在のステートが最高ランクの場合は何も起こりません。
* 下限値「次に低ランクな同属ステートのランク値」と等値以下になれば解除されます。現在のステートが最低ランクの場合は何も起こりません。

***
### 【element】/【eRate】
グループに属性を関連付けます。デフォルトはどちらも0で、この状態だと何も起こりません。  
属性によるダメージを受けると、それに関連づけられたグループの「初期ステート」が付加されます。eRateでその付加確率を設定できます。  
属性による初期ステートの「付加」は、他のステートのsFlag[addedState]および[addedStateGroup]を動作させます。  
属性ダメージによる実際の付加確率は、eRate * [初期ステートに対する耐性率] * [運による補正率] です。  
付加される初期ステートは以下のように決められます。
#### target[rankUp]の場合
	最もランク値の低いものが付加されます。
#### target[rankDown]の場合
	最もランク値の高いものが付加されます。
#### targetがそれ以外の場合
* rankType[higher]の場合：最もランク値の低いものが付加されます。
* rankType[lower]の場合：最もランク値の高いものが付加されます。
* rankTypeがそれ以外の場合、グループの中からランダムに選ばれます。

### 【counter】
このグループに属するステートを相殺するグループ(相殺グループ)を設定できます。デフォルトは０で、この状態だと何も起こりません。  
なんらかのステートを付加しようとしたとき、そのステートの相殺グループに属するステートが既に付加されていれば、
そのステートの付加は無効になり、相殺グループに属するステートも解除されることになります。  
type[neutral]と似たような挙動になりますが、「中和」はxFlag[remove]を作動させないのに対し、「相殺」はxFlag[remove]を作動させます。  
相殺グループの設定にもcounterを設定することで、両者のグループが同時に共存することはなくなります。  

***
## ◆ランク値について◆
<RSGrank:xx>により設定するランク値は、以下の２点の用途のために用いられます。

### 【ランク値による同属ステートに対する上書と無効】
ノートタグでランク値が設定されていない場合、「優先度」で入力されている値がランク値として処理に用いられます。  
ランク値を必要としないグループである場合は必要ありません。

### 【sFlagに有効範囲がある場合のランク値の利用】
sFlag[param]および[rateOfHMT]の場合、ランク値の数値そのものが判定に大きく関わってきます。
切替の判定で用いる値の有効範囲について、その上限値と下限値を決めるため、ランク値の数値を転用することになります。
各ステートの上限値と下限値の決定方法は、以下のような仕様になっています。
#### rankTypeが[higher]の場合：
* 上限値：次に高いステートのランク値・次に高いステートがない場合は無限大
* 下限値：そのステートのランク値・次に低いステートがない場合は無限小
* 下限値 ≦ 有効範囲 < 上限値
#### rankTypeが[lower]の場合：
* 上限値：そのステートのランク値・次に高いステートがない場合は無限大
* 下限値：次に低いステートの同属ランク値・次に低いステートがない場合は無限小
* 下限値 ≦ 有効範囲 < 上限値
#### rankTypegが[none]の場合：
##### かつtargetが[rankUp]の場合：
* 上限値：次に高い同属ステートのランク値・次に高いステートがない場合は無限大
* 下限値：そのステートのランク値・次に低いステートがない場合は無限小
* 下限値　≦ 有効範囲　< 上限値
##### かつtargetが[rankDown]の場合：
* 上限値：そのステートのランク値・次に高いステートがない場合は無限大
* 下限値：次に低いステートの同属ランク値・次に低いステートがない場合は無限小
* 下限値　≦ 有効範囲　< 上限値
##### かつtargetが[none]あるいは[state]の場合：
* 上限値：次に高い同属ステートのランク値・次に高いステートがない場合は無限大
* 下限値：次に低いステートの同属ランク値・次に低いステートがない場合は無限小
* 下限値 < 有効範囲 < 上限値  

***
## ◆ノートタグ◆
必要に応じて、各ステートの設定画面のメモ欄に、以下のようにノートタグを記述します。

### `<RSGgroupId:xx>`(半角数字)
グループのID番号を設定します。ステートは１つのグループにのみ属せます。

### `<RSGrank:xx>`(半角数字)
ステートのグループ内でのランク値を設定します。  
この記述がない場合、ステートの「優先度」がランク値として用いられます。

### `<RSGxRate:xx>`(半角数字)
拡張フラグ(xFlag)によるステート切り替えの作動確率です。
この記述がない場合、xFlagは必ず作動します。

### `<RSGsRate:xx>`(半角数字)
特殊フラグ(sFlag)によるステート切り替えの作動確率です。

### `<RSGtargetState:xx>`(半角数字)
target[state]のグループに属する場合は設定して下さい。
設定しない場合、切り替えが作動しません。

***
# アップデート履歴
## v0.6.0 2018/05/12
* ステートの継続ターン数の引き継ぎオプションを追加
* 大部分のxFlag・sFlagが作動しなかった問題を解決
## v0.5.0 2018/05/09  
* データベースをリスト形式に統一  
* その他、コーディングのミスを修正  
* 別途オンラインヘルプ作成のためプラグイン内のヘルプ・コメントアウト等を簡略化  
## v0.2.0 2018/05/06  
* beta版公開

# 仕様変更予定
* v0.7.0 〜　v0.9.0
	* sFlag[param]および[rateOfHMT]の設定におけるtarget[random]の動作を「有効範囲にあったステートの中からランダムに切り替える」に変更
	* 「切替」「属性による初期ステート付加時」「相殺」にグループごとに設定したメッセージを表示できる仕様を追加
	* sFlag[addedStateGroup]が自分のグループの付加にも反応するように変更
	* sFlag[variable](ゲーム内変数によるフラグ)およびsFlag[switch](ゲーム内スイッチによるフラグ)を追加
